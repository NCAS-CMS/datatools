Bootstrap: docker
From: ubuntu:24.04

%labels
    Author NCAS-CMS
    Description "datatools with micromamba and PyQt6"

%post
    set -e

    # ---- system base ----
    apt-get update && apt-get install -y \
        ca-certificates \
        curl \
        bzip2 \
        build-essential \
        git \
        pkg-config \
        libgl1 \
        libxkbcommon0 \
        libxrandr2 \
        libxi6 \
        libxtst6 \
        vim-gtk3 \
        libxcb-cursor0 \
        qt6-base-dev \
        qt6-base-dev-tools \
        proj-bin \
        proj-data \
        graphviz \
        plantuml \
        software-properties-common \
	xterm \
    	libx11-6 \
   	libx11-xcb1 \
   	libxcb1 \
   	libxcb-cursor0 \
   	libxcb-keysyms1 \
   	libxcb-render0 \
   	libxcb-shm0 \
   	libxcb-xinerama0 \
   	libxrender1 \
   	libxext6 \
   	libxfixes3 \
   	libglu1-mesa \
        libglx-mesa0 \
   	libgl1-mesa-dri \
	mesa-utils \
        x11-utils \
	libxcb-icccm4 \
    	libxcb-image0 \
    	libxcb-render-util0 \
    	libxcb-xkb1 \
    	libxkbcommon-x11-0 \
	&& rm -rf /var/lib/apt/lists/*


    # ---- install micromamba ----
    curl -L https://micro.mamba.pm/api/micromamba/linux-64/latest \
        | tar -xvj -C /usr/local/bin --strip-components=1 bin/micromamba

    # ---- micromamba config ----
    export MAMBA_ROOT_PREFIX=/opt/micromamba
    export PATH=/usr/local/bin:$PATH

    # ---- create environment ----
    micromamba create -y -p /opt/env \
        -c conda-forge \
	python=3.12 \
  	ipython \
  	jupyterlab \
  	notebook \
  	gcc \
  	gfortran \
  	make \
  	cmake \
  	libtool \
  	netcdf4 \
  	h5py \
  	h5netcdf \
  	pyfive \
  	udunits2 \
  	xarray \
  	pip

    # ---- install python deps ----
    /opt/env/bin/pip install --no-cache-dir \
        pyqt6 \
	cfdm \
	cf-python \
        cf-view \
	cfs3        

    # ---- cleanup and nuke dash ----
    micromamba clean -a -y
    rm /bin/sh && ln -s /bin/bash /bin/sh

%environment
    # runtime environment
    export MAMBA_ROOT_PREFIX=/opt/micromamba
    export PATH=/opt/env/bin:/usr/local/bin:$PATH
    export PYTHONNOUSERSITE=1
    export CACHE_BUSTER=1

%runscript
    exec /bin/bash "$@"
%startscript
    exec /bin/bash "$@"
